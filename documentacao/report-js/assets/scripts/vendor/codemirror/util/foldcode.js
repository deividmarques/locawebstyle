//   Copyright (C) 2011 by Daniel Glazman <daniel@glazman.org>
CodeMirror.tagRangeFinder=function(t,e){for(var i="A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",n=i+"-:.0-9\\u00B7\\u0300-\\u036F\\u203F-\\u2040",a=new RegExp("^["+i+"]["+n+"]*"),o=t.getLine(e.line),r=!1,s=null,l=e.ch;!r;){if(l=o.indexOf("<",l),-1==l)return;if(l+1<o.length&&"/"==o[l+1])l++;else if(o.substr(l+1).match(a)){var c=o.indexOf(">",l+1);if(-1==c){for(var d=e.line+1,u=!1,f=t.lineCount();f>d&&!u;){var p=t.getLine(d);if(c=p.indexOf(">"),-1!=c){u=!0;var h=p.lastIndexOf("/",c);if(-1!=h&&c>h){var m=o.substr(h,c-h+1);if(!m.match(/\/\s*\>/))return}}d++}r=!0}else{var _=o.lastIndexOf("/",c);if(-1==_)r=!0;else{var m=o.substr(_,c-_+1);m.match(/\/\s*\>/)||(r=!0)}}if(r){var y=o.substr(l+1);s=y.match(a),s?(s=s[0],-1!=o.indexOf("</"+s+">",l)&&(r=!1)):r=!1}r||l++}else l++}if(r)for(var g="(\\<\\/"+s+"\\>)|(\\<"+s+"\\>)|(\\<"+s+"\\s)|(\\<"+s+"$)",v=new RegExp(g),b="</"+s+">",x=1,d=e.line+1,f=t.lineCount();f>d;){o=t.getLine(d);var w=o.match(v);if(w)for(var k=0;k<w.length;k++)if(w[k]==b?x--:x++,!x)return{from:{line:e.line,ch:c+1},to:{line:d,ch:w.index}};d++}else;},CodeMirror.braceRangeFinder=function(t,e){for(var i,n,a=e.line,o=t.getLine(a),r=o.length;;){var s=o.lastIndexOf("{",r);if(s<e.ch)break;if(n=t.getTokenAt({line:a,ch:s}).type,!/^(comment|string)/.test(n)){i=s;break}r=s-1}if(!(null==i||o.lastIndexOf("}")>i)){var l,c,d=1,u=t.lineCount();t:for(var f=a+1;u>f;++f)for(var p=t.getLine(f),h=0;;){var m=p.indexOf("{",h),_=p.indexOf("}",h);if(0>m&&(m=p.length),0>_&&(_=p.length),h=Math.min(m,_),h==p.length)break;if(t.getTokenAt({line:f,ch:h+1}).type==n)if(h==m)++d;else if(!--d){l=f,c=h;break t}++h}if(null!=l&&l!=a+1)return{from:{line:a,ch:i+1},to:{line:l,ch:c}}}},CodeMirror.indentRangeFinder=function(t,e){for(var i=t.getOption("tabSize"),n=t.getLine(e.line),a=CodeMirror.countColumn(n,null,i),o=e.line+1,r=t.lineCount();r>o;++o){var s=t.getLine(o);if(CodeMirror.countColumn(s,null,i)<a)return{from:{line:e.line,ch:n.length},to:{line:o,ch:s.length}}}},CodeMirror.newFoldFunction=function(t,e){if(null==e&&(e="\u2194"),"string"==typeof e){var i=document.createTextNode(e);e=document.createElement("span"),e.appendChild(i),e.className="CodeMirror-foldmarker"}return function(i,n){"number"==typeof n&&(n={line:n,ch:0});var a=t(i,n);if(a){for(var o=i.findMarksAt(a.from),r=0,s=0;s<o.length;++s)o[s].__isFold&&(++r,o[s].clear());if(!r){var l=e.cloneNode(!0);CodeMirror.on(l,"mousedown",function(){c.clear()});var c=i.markText(a.from,a.to,{replacedWith:l,clearOnEnter:!0,__isFold:!0})}}}};